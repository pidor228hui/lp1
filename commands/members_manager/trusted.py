from vkbottle.api import UserApi
from vkbottle.framework.framework.rule import FromMe
from vkbottle.user import Blueprint, Message

from logger import logger_decorator
from objects import Database
from objects.trusted_user import TrustedUser
from utils import get_ids_by_message, edit_message, get_full_name_by_member_id

user = Blueprint(
    name='trusted_blueprint'
)


@user.on.message_handler(
    FromMe(),
    text=[
        '<prefix:service_prefix> +–¥–æ–≤ [id<user_id:int>|<foo>',
        '<prefix:service_prefix> +–¥–æ–≤ [club<group_id:int>|<foo>',
        '<prefix:service_prefix> +–¥–æ–≤ https://vk.com/<domain>',
        '<prefix:service_prefix> +–¥–æ–≤',
    ]
)
@logger_decorator
async def add_trusted_member_wrapper(
        message: Message,
        domain: str = None,
        user_id: int = None,
        group_id: int = None,
        **kwargs
):
    db = Database.get_current()
    member_id = user_id if user_id else None
    if not user_id and group_id:
        member_id = -group_id

    member_ids = await get_ids_by_message(message, member_id, domain)
    if not member_ids:
        await edit_message(
            message,
            f'‚ö† –í–∞—Å—å –∞ –∫–æ–≥–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ?'
        )
        return

    member_id = member_ids[0]
    if member_id == await message.api.user_id:
        await edit_message(
            message,
            f'‚ö† –¢–∞–∫-—Ç–æ —Ç—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å...'
        )
        return

    if member_id > 0:
        name = f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å [id{member_id}|{await get_full_name_by_member_id(message.api, member_id)}]'
    else:
        name = f'–ì—Ä—É–ø–ø–∞ [club{abs(member_id)}|{await get_full_name_by_member_id(message.api, member_id)}]'

    if member_id in [
        muted_member.member_id
        for muted_member in db.muted_members
        if muted_member.chat_id == message.peer_id
    ]:
        await edit_message(
            message,
            f'‚ö† {name} —è –µ–º—É —É–∂–µ –≤–µ—Ä—é'
        )
        return
    db.trusted.append(TrustedUser(user_id=member_id))
    db.save()
    await edit_message(
        message,
        f'‚úÖ —á–µ–ª–∏–∫ - {name} –≤—Ç—ë—Ä—Å—è –≤ –¥–æ–≤–µ—Ä–∏–µüòé '
    )


@user.on.message_handler(
    FromMe(),
    text=[
        '<prefix:service_prefix> -–¥–æ–≤ [id<user_id:int>|<foo>',
        '<prefix:service_prefix> -–¥–æ–≤ [club<group_id:int>|<foo>',
        '<prefix:service_prefix> -–¥–æ–≤ https://vk.com/<domain>',
        '<prefix:service_prefix> -–¥–æ–≤',
    ]
)
@logger_decorator
async def remove_trusted_member_wrapper(
        message: Message,
        domain: str = None,
        user_id: int = None,
        group_id: int = None,
        **kwargs
):
    db = Database.get_current()
    member_id = user_id if user_id else None
    if not user_id and group_id:
        member_id = -group_id

    member_ids = await get_ids_by_message(message, member_id, domain)
    if not member_ids:
        await edit_message(
            message,
            f'‚ö† –∫–æ–≥–æ —É–¥–∞–ª–∏—Ç—å —Ç–æ?'
        )
        return

    member_id = member_ids[0]

    if member_id > 0:
        name = f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å  [id{member_id}|{await get_full_name_by_member_id(message.api, member_id)}]'
    else:
        name = f'–ì—Ä—É–ø–ø–∞ [club{abs(member_id)}|{await get_full_name_by_member_id(message.api, member_id)}]'

    if member_id not in [
        trusted_member.user_id
        for trusted_member in db.trusted
    ]:
        await edit_message(
            message,
            f'‚ö† —è {name} –∏ —Ç–∞–∫ –Ω–µ –∑–Ω–∞—é...'
        )
        return
    trusted = None
    for ign in db.trusted:
        if ign.user_id == member_id:
            trusted = ign
    db.trusted.remove(trusted)
    db.save()
    await edit_message(
        message,
        f'‚úÖ {name} –ø–æ—Å–ª–∞–Ω —Å –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö...'
    )


async def show_trusted_members(
        database: Database,
        api: UserApi
) -> str:
    user_ids = [
        trusted.user_id
        for trusted in database.trusted
        if trusted.user_id > 0
    ]
    group_ids = [
        abs(trusted.user_id)
        for trusted in database.trusted
        if trusted.user_id < 0
    ]

    if not user_ids and not group_ids:
        return "üìÉ –¢—ã –∏ —Ç–∞–∫ –Ω–∏–∫–æ–º—É –Ω–µ –≤–µ—Ä–∏—à—å"

    index = 1
    message = "üìÉ —Ç—ã –≤–µ—Ä–∏—à—å –∏–º\n"

    if user_ids:
        for vk_user in await api.users.get(user_ids=user_ids):
            message += f"{index}. [id{vk_user.id}|{vk_user.first_name} {vk_user.last_name}]\n"
            index += 1

    if group_ids:
        for vk_group in await api.groups.get_by_id(group_ids=group_ids):
            message += f'{index}. [club{vk_group.id}|{vk_group.name}]'
            index += 1
    return message


@user.on.message_handler(
    FromMe(),
    text=[
        '<prefix:service_prefix> –¥–æ–≤—ã',
    ]
)
@logger_decorator
async def show_trusted_members_wrapper(message: Message, **kwargs):
    db = Database.get_current()
    await edit_message(
        message,
        await show_trusted_members(
            db,
            message.api
        )
    )
